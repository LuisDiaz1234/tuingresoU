<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IngresoU – Admin</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;max-width:1100px;margin:0 auto;padding:24px;background:#f8fafc;color:#0f172a}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .card{background:#fff;border:1px solid #e2e8f0;border-radius:12px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.04);margin:12px 0}
    label{display:block;margin:8px 0 4px}
    input,select,textarea{width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:8px}
    textarea{min-height:90px}
    button{padding:10px 14px;border:0;border-radius:10px;background:#0ea5e9;color:#fff;font-weight:600;cursor:pointer}
    button:disabled{background:#94a3b8;cursor:not-allowed}
    .muted{color:#475569}
    .ok{color:#059669}.err{color:#dc2626}
    nav a{margin-right:12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #e2e8f0;text-align:left;vertical-align:top}
    small.code{font-family:ui-monospace,Menlo,Consolas,monospace;background:#f1f5f9;border:1px solid #e2e8f0;border-radius:6px;padding:2px 6px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:980px){ .grid{grid-template-columns:1fr;} }
    .row{display:flex;gap:8px;align-items:center;margin-top:6px}
    .row input{flex:1}
  </style>
</head>
<body>
<header>
  <h1>IngresoU</h1>
  <nav>
    <a href="/index.html">Inicio</a>
    <a href="/premium.html">Premium</a>
    <a href="/leaderboard.html">Ranking</a>
  </nav>
</header>

<div class="card">
  <h2>Admin – token</h2>
  <p class="muted">Pega tu <strong>ADMIN_TOKEN</strong>. No lo compartas.</p>
  <label>ADMIN_TOKEN</label>
  <input id="adminToken" placeholder="pégalo aquí">
  <p id="tokStatus" class="muted"></p>
</div>

<div class="grid">
  <!-- ====== KEYS ====== -->
  <div class="card">
    <h3>Emitir nueva KEY</h3>
    <label>Code</label><input id="code" placeholder="UTP-XXXX-0001">
    <label>Plan</label><input id="plan" placeholder="mensual" value="mensual">
    <label>Universidad</label>
    <select id="university"><option>UTP</option><option>UP</option></select>
    <label>Expira (ISO 8601)</label><input id="expires_at" placeholder="2025-12-31T23:59:59Z">
    <div style="margin-top:12px"><button id="btnIssue">Emitir</button></div>
    <p id="issueStatus" class="muted"></p>
  </div>

  <div class="card">
    <h3>Listado de keys</h3>
    <label>Filtro texto (code)</label><input id="q" placeholder="UTP-">
    <label>Redimidas</label>
    <select id="redeemed"><option value="">Todas</option><option value="1">Sí</option><option value="0">No</option></select>
    <label>Universidad</label>
    <select id="u"><option value="">Todas</option><option>UTP</option><option>UP</option></select>
    <div style="margin-top:12px"><button id="btnList">Listar</button></div>
    <div id="listWrap" class="muted" style="margin-top:10px">—</div>
  </div>
</div>

<!-- ====== BANCO DE PREGUNTAS ====== -->
<div class="card">
  <h3>Banco de preguntas – crear/editar</h3>
  <div class="grid">
    <div>
      <input type="hidden" id="q_id">
      <label>Tema</label>
      <select id="q_topic"><option value="algebra">Álgebra</option><option value="logico">Razonamiento Lógico</option><option value="lectura">Comprensión Lectora</option></select>
      <label>Pregunta</label>
      <textarea id="q_prompt" placeholder="Escribe la pregunta..."></textarea>

      <label>Opciones (2 a 6)</label>
      <div id="choices"></div>
      <div class="row"><button id="btnAddChoice" type="button">Añadir opción</button></div>

      <label>Índice de respuesta correcta (0..n-1)</label>
      <input id="q_answer_index" type="number" min="0" value="0">

      <label>Dificultad (opcional)</label>
      <input id="q_difficulty" placeholder="facil / media / dificil">
      <div class="row">
        <label><input id="q_active" type="checkbox" checked> Activa</label>
        <button id="btnSaveQuestion" type="button">Guardar pregunta</button>
      </div>
      <p id="q_status" class="muted"></p>
    </div>

    <div>
      <h4>Buscar/Listar</h4>
      <label>Tema</label>
      <select id="f_topic"><option value="">Todos</option><option value="algebra">Álgebra</option><option value="logico">Razonamiento Lógico</option><option value="lectura">Comprensión Lectora</option></select>
      <label>Texto</label><input id="f_q" placeholder="contiene...">
      <label>Activa</label>
      <select id="f_active"><option value="">Todas</option><option value="1">Sí</option><option value="0">No</option></select>
      <div class="row"><button id="btnListQ">Listar preguntas</button></div>
      <div id="q_list" class="muted" style="margin-top:10px">—</div>
    </div>
  </div>
</div>

<script>
const TZ_OPTS = { timeZone: 'America/Panama', hour12: false };

function authHeaders(){
  const tok = (document.getElementById('adminToken').value || '').trim();
  if(!tok) return null;
  return {'Authorization':'Bearer '+tok, 'Content-Type':'application/json'};
}
function setBusy(btn, busy, idle, busyTxt){
  btn.disabled = !!busy;
  btn.textContent = busy ? (busyTxt||'Procesando...') : (idle||btn.textContent);
}
document.getElementById('adminToken').addEventListener('input', ()=>{
  const tok = (document.getElementById('adminToken').value || '').trim();
  document.getElementById('tokStatus').textContent = tok ? 'Token listo.' : 'Pega tu ADMIN_TOKEN.';
});

/* ===== KEYS ===== */
document.getElementById('btnIssue').addEventListener('click', async ()=>{
  const btn = document.getElementById('btnIssue');
  const headers = authHeaders();
  if(!headers){ document.getElementById('issueStatus').innerHTML = '<span class="err">Falta ADMIN_TOKEN</span>'; return; }
  const payload = {
    code: (document.getElementById('code').value||'').toUpperCase().trim(),
    plan: (document.getElementById('plan').value||'').trim(),
    university: (document.getElementById('university').value||'').trim().toUpperCase(),
    expires_at: (document.getElementById('expires_at').value||'').trim()
  };
  if(!payload.code || !payload.plan || !payload.university || !payload.expires_at){
    document.getElementById('issueStatus').innerHTML = '<span class="err">Completa todos los campos.</span>'; return;
  }
  try{
    setBusy(btn,true,'Emitir','Emitiendo...');
    const res = await fetch('/api/admin/issue-key',{method:'POST', headers, body: JSON.stringify(payload)});
    const data = await res.json();
    document.getElementById('issueStatus').innerHTML = data.ok ? '<span class="ok">OK: KEY emitida</span>' : '<span class="err">'+(data.error||'Error')+'</span>';
  }catch(e){
    document.getElementById('issueStatus').innerHTML = '<span class="err">'+e.message+'</span>';
  }finally{
    setBusy(btn,false,'Emitir');
  }
});

document.getElementById('btnList').addEventListener('click', async ()=>{
  const btn = document.getElementById('btnList');
  const headers = authHeaders();
  if(!headers){ document.getElementById('listWrap').innerHTML = '<span class="err">Falta ADMIN_TOKEN</span>'; return; }
  try{
    setBusy(btn,true,'Listar','Buscando...');
    const params = new URLSearchParams();
    const q = (document.getElementById('q').value||'').trim();
    const redeemed = document.getElementById('redeemed').value;
    const u = document.getElementById('u').value;
    if(q) params.set('q', q);
    if(redeemed !== '') params.set('redeemed', redeemed);
    if(u) params.set('university', u);
    const res = await fetch('/api/admin/issue-key?'+params.toString(), {headers});
    const data = await res.json();
    if(!data.ok || !Array.isArray(data.items)){ document.getElementById('listWrap').innerHTML = '<span class="err">Error al listar</span>'; return; }
    if(data.items.length===0){ document.getElementById('listWrap').textContent = 'Sin resultados.'; return; }
    const rows = data.items.map(k=>`<tr>
      <td><small class="code">${k.code}</small></td>
      <td>${k.plan}</td>
      <td>${k.university}</td>
      <td>${new Date(k.expires_at).toLocaleString('es-PA', TZ_OPTS)}</td>
      <td>${k.redeemed?'sí':'no'}</td>
      <td>${k.redeemed_by_email||'-'}</td>
      <td>${new Date(k.created_at).toLocaleString('es-PA', TZ_OPTS)}</td>
    </tr>`).join('');
    document.getElementById('listWrap').innerHTML =
      '<table><thead><tr><th>Code</th><th>Plan</th><th>Univ</th><th>Expira (PA)</th><th>Redimida</th><th>Email</th><th>Creada (PA)</th></tr></thead><tbody>'+rows+'</tbody></table>';
  }catch(e){
    document.getElementById('listWrap').innerHTML = '<span class="err">'+e.message+'</span>';
  }finally{
    setBusy(btn,false,'Listar');
  }
});

/* ===== PREGUNTAS ===== */
const choicesWrap = document.getElementById('choices');
function addChoice(val=''){
  const i = choicesWrap.querySelectorAll('input.choice').length;
  if(i>=6) return;
  const div = document.createElement('div');
  div.className='row';
  div.innerHTML = `<input class="choice" placeholder="Opción ${i}" value="${(val||'').replace(/"/g,'&quot;')}">
    <button type="button" class="btnDel">X</button>`;
  div.querySelector('.btnDel').addEventListener('click', ()=>{ div.remove(); });
  choicesWrap.appendChild(div);
}
['','','',''].forEach(()=>addChoice()); // 4 por defecto
document.getElementById('btnAddChoice').addEventListener('click', ()=>addChoice(''));

document.getElementById('btnSaveQuestion').addEventListener('click', async ()=>{
  const btn = document.getElementById('btnSaveQuestion');
  const headers = authHeaders();
  if(!headers){ document.getElementById('q_status').innerHTML = '<span class="err">Falta ADMIN_TOKEN</span>'; return; }

  const id = (document.getElementById('q_id').value||'').trim() || null;
  const topic = document.getElementById('q_topic').value;
  const prompt = (document.getElementById('q_prompt').value||'').trim();
  const choices = Array.from(document.querySelectorAll('input.choice')).map(i=>i.value.trim()).filter(Boolean);
  const answer_index = parseInt(document.getElementById('q_answer_index').value,10) || 0;
  const difficulty = (document.getElementById('q_difficulty').value||'').trim() || null;
  const active = document.getElementById('q_active').checked;

  if(!prompt || choices.length<2 || choices.length>6 || answer_index<0 || answer_index>=choices.length){
    document.getElementById('q_status').innerHTML = '<span class="err">Revisa pregunta, opciones (2-6) e índice correcto.</span>'; return;
  }

  try{
    setBusy(btn,true,'Guardar pregunta','Guardando...');
    const res = await fetch('/api/admin/questions-upsert', {
      method: id ? 'PUT' : 'POST',
      headers, body: JSON.stringify({ id, topic, prompt, choices, answer_index, difficulty, active })
    });
    const data = await res.json();
    if(data.ok){
      document.getElementById('q_status').innerHTML = '<span class="ok">Guardado. ID: '+data.id+'</span>';
      document.getElementById('q_id').value = data.id || '';
    }else{
      document.getElementById('q_status').innerHTML = '<span class="err">'+(data.error||'Error')+'</span>';
    }
  }catch(e){
    document.getElementById('q_status').innerHTML = '<span class="err">'+e.message+'</span>';
  }finally{
    setBusy(btn,false,'Guardar pregunta');
  }
});

document.getElementById('btnListQ').addEventListener('click', async ()=>{
  const btn = document.getElementById('btnListQ');
  const headers = authHeaders();
  if(!headers){ document.getElementById('q_list').innerHTML = '<span class="err">Falta ADMIN_TOKEN</span>'; return; }
  try{
    setBusy(btn,true,'Listar preguntas','Buscando...');
    const params = new URLSearchParams();
    const t = document.getElementById('f_topic').value;
    const q = (document.getElementById('f_q').value||'').trim();
    const a = document.getElementById('f_active').value;
    if(t) params.set('topic', t);
    if(q) params.set('q', q);
    if(a) params.set('active', a);
    const res = await fetch('/api/admin/questions-list?'+params.toString(), {headers});
    const data = await res.json();
    if(!data.ok || !Array.isArray(data.items) || data.items.length===0){
      document.getElementById('q_list').textContent = 'Sin resultados.'; return;
    }
    const rows = data.items.map(item=>`<tr>
      <td><small class="code">${item.id}</small></td>
      <td>${item.topic}</td>
      <td>${item.prompt}</td>
      <td>${item.choices.map((c,i)=> (i===item.answer_index?'<strong>'+c+'</strong>':c)).join('<br>')}</td>
      <td>${item.difficulty||'-'}</td>
      <td>${item.active?'sí':'no'}</td>
      <td>${new Date(item.created_at).toLocaleString('es-PA', ${JSON.stringify(TZ_OPTS)})}</td>
      <td><button type="button" data-id="${item.id}" class="btnLoad">cargar</button></td>
    </tr>`).join('');
    document.getElementById('q_list').innerHTML =
      '<table><thead><tr><th>ID</th><th>Tema</th><th>Pregunta</th><th>Opciones</th><th>Dif.</th><th>Activa</th><th>Creada (PA)</th><th>Editar</th></tr></thead><tbody>'+rows+'</tbody></table>';

    // Cargar en el formulario para editar
    document.querySelectorAll('.btnLoad').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.getAttribute('data-id');
        const item = data.items.find(x=>x.id===id);
        if(!item) return;
        document.getElementById('q_id').value = item.id;
        document.getElementById('q_topic').value = item.topic;
        document.getElementById('q_prompt').value = item.prompt;
        choicesWrap.innerHTML = '';
        item.choices.forEach(c=>addChoice(c));
        document.getElementById('q_answer_index').value = item.answer_index;
        document.getElementById('q_difficulty').value = item.difficulty||'';
        document.getElementById('q_active').checked = !!item.active;
        window.scrollTo({top:0,behavior:'smooth'});
      });
    });

  }catch(e){
    document.getElementById('q_list').innerHTML = '<span class="err">'+e.message+'</span>';
  }finally{
    setBusy(btn,false,'Listar preguntas');
  }
});
</script>
</body>
</html>

