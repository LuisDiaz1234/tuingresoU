<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IngresoU – Admin</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;max-width:1100px;margin:0 auto;padding:24px;background:#f8fafc;color:#0f172a}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    nav a{margin-right:12px;color:#334155;text-decoration:none;font-weight:600}
    nav a:hover{color:#0ea5e9}
    .tabs{display:flex;gap:12px;margin-bottom:12px}
    .tabs button{padding:8px 12px;border:1px solid #cbd5e1;background:#fff;border-radius:8px;cursor:pointer}
    .tabs button.active{background:#0ea5e9;color:#fff;border-color:#0ea5e9}
    .card{background:#fff;border:1px solid #e2e8f0;border-radius:12px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.04);margin:12px 0}
    label{display:block;margin:8px 0 4px}
    input,select,textarea{width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:8px}
    textarea{min-height:90px}
    button{padding:10px 14px;border:0;border-radius:10px;background:#0ea5e9;color:#fff;font-weight:600;cursor:pointer}
    button:disabled{background:#94a3b8;cursor:not-allowed}
    .muted{color:#475569}
    .ok{color:#059669}.err{color:#dc2626}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #e2e8f0;text-align:left;vertical-align:top}
    small.code{font-family:ui-monospace,Menlo,Consolas,monospace;background:#f1f5f9;border:1px solid #e2e8f0;border-radius:6px;padding:2px 6px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:980px){ .grid{grid-template-columns:1fr; } }
    .row{display:flex;gap:8px;align-items:center;margin-top:6px}
  </style>
</head>
<body>
<header>
  <h1>IngresoU</h1>
  <nav>
    <a href="/index.html">Inicio</a>
    <a href="/premium.html">Premium</a>
    <a href="/leaderboard.html">Ranking</a>
  </nav>
</header>

<div class="card">
  <h2>Admin</h2>
  <label>ADMIN_TOKEN</label>
  <input id="adminToken" placeholder="pégalo aquí">
  <p id="tokStatus" class="muted"></p>

  <div class="tabs">
    <button data-tab="keys" class="active">Keys</button>
    <button data-tab="questions">Banco de preguntas</button>
    <button data-tab="yappy">Pagos Yappy</button>
  </div>
</div>

<!-- ===== TAB KEYS ===== -->
<div id="tab-keys">
  <div class="grid">
    <div class="card">
      <h3>Emitir nueva KEY</h3>
      <label>Code</label><input id="code" placeholder="UTP-XXXX-0001">
      <label>Plan</label><input id="plan" placeholder="mensual" value="mensual">
      <label>Universidad</label>
      <select id="university"><option>UTP</option><option>UP</option></select>
      <label>Expira (ISO 8601)</label><input id="expires_at" placeholder="2025-12-31T23:59:59Z">
      <div style="margin-top:12px"><button id="btnIssue">Emitir</button></div>
      <p id="issueStatus" class="muted"></p>
    </div>

    <div class="card">
      <h3>Listado de keys</h3>
      <label>Filtro texto (code)</label><input id="q" placeholder="UTP-">
      <label>Redimidas</label>
      <select id="redeemed"><option value="">Todas</option><option value="1">Sí</option><option value="0">No</option></select>
      <label>Universidad</label>
      <select id="u"><option value="">Todas</option><option>UTP</option><option>UP</option></select>
      <div style="margin-top:12px"><button id="btnList">Listar</button></div>
      <div id="listWrap" class="muted" style="margin-top:10px">—</div>
    </div>
  </div>
</div>

<!-- ===== TAB QUESTIONS ===== -->
<div id="tab-questions" style="display:none">
  <div class="card">
    <h3>Banco de preguntas – crear/editar</h3>
    <div class="grid">
      <div>
        <input type="hidden" id="q_id">
        <label>Tema</label>
        <select id="q_topic">
          <option value="algebra">Álgebra</option>
          <option value="logico">Razonamiento Lógico</option>
          <option value="lectura">Comprensión Lectora</option>
        </select>

        <label>Pregunta</label>
        <textarea id="q_prompt" placeholder="Escribe la pregunta..."></textarea>

        <label>Opciones (2 a 6)</label>
        <div id="choices"></div>
        <div class="row"><button id="btnAddChoice" type="button">Añadir opción</button></div>

        <label>Índice de respuesta correcta (0..n-1)</label>
        <input id="q_answer_index" type="number" min="0" value="0">

        <label>Dificultad (opcional)</label>
        <input id="q_difficulty" placeholder="facil / media / dificil">

        <label>Explicación (opcional)</label>
        <textarea id="q_explanation" placeholder="Explica brevemente por qué la respuesta es correcta."></textarea>

        <div class="row">
          <label><input id="q_active" type="checkbox" checked> Activa</label>
          <button id="btnSaveQuestion" type="button">Guardar pregunta</button>
        </div>
        <p id="q_status" class="muted"></p>
      </div>

      <div>
        <h4>Buscar/Listar</h4>
        <label>Tema</label>
        <select id="f_topic"><option value="">Todos</option><option value="algebra">Álgebra</option><option value="logico">Razonamiento Lógico</option><option value="lectura">Comprensión Lectora</option></select>
        <label>Texto</label><input id="f_q" placeholder="contiene...">
        <label>Activa</label>
        <select id="f_active"><option value="">Todas</option><option value="1">Sí</option><option value="0">No</option></select>
        <div class="row"><button id="btnListQ">Listar preguntas</button></div>
        <div id="q_list" class="muted" style="margin-top:10px">—</div>
      </div>
    </div>
  </div>
</div>

<!-- ===== TAB YAPPY ===== -->
<div id="tab-yappy" style="display:none">
  <div class="card">
    <h3>Pagos Yappy – pendientes</h3>
    <div class="row">
      <button id="btnYList">Refrescar</button>
      <select id="ystatus">
        <option value="pending">Pendientes</option>
        <option value="approved">Aprobados</option>
        <option value="rejected">Rechazados</option>
      </select>
    </div>
    <div id="ylist" class="muted" style="margin-top:10px">—</div>
  </div>
  <div class="card">
    <h4>Comprobante seleccionado</h4>
    <div id="yproof">—</div>
    <div class="row" style="margin-top:10px">
      <button id="btnApprove">Aprobar y activar</button>
      <button id="btnReject">Rechazar</button>
    </div>
    <p id="yStatus" class="muted"></p>
  </div>
</div>

<script>
const TZ_OPTS = { timeZone: 'America/Panama', hour12: false };

function authHeaders(){
  const tok = (document.getElementById('adminToken').value || '').trim();
  document.getElementById('tokStatus').textContent = tok ? 'Token listo.' : 'Pega tu ADMIN_TOKEN.';
  if(!tok) return null;
  return {'Authorization':'Bearer '+tok, 'Content-Type':'application/json'};
}
function setBusy(btn, busy, idle, busyTxt){ if(!btn) return; btn.disabled=!!busy; btn.textContent = busy ? (busyTxt||'...') : (idle||btn.textContent); }
document.getElementById('adminToken').addEventListener('input', authHeaders);

/* Tabs */
document.querySelectorAll('.tabs button').forEach(b=>{
  b.addEventListener('click', ()=>{
    document.querySelectorAll('.tabs button').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    const tab = b.getAttribute('data-tab');
    document.getElementById('tab-keys').style.display = (tab==='keys')?'':'none';
    document.getElementById('tab-questions').style.display = (tab==='questions')?'':'none';
    document.getElementById('tab-yappy').style.display = (tab==='yappy')?'':'none';
  });
});

/* ===== KEYS ===== */
document.getElementById('btnIssue').addEventListener('click', async ()=>{
  const btn = document.getElementById('btnIssue');
  const headers = authHeaders(); if(!headers){ return; }
  const payload = {
    code: (document.getElementById('code').value||'').toUpperCase().trim(),
    plan: (document.getElementById('plan').value||'').trim(),
    university: (document.getElementById('university').value||'').trim().toUpperCase(),
    expires_at: (document.getElementById('expires_at').value||'').trim()
  };
  try{
    setBusy(btn,true,'Emitir','Emitiendo...');
    const r = await fetch('/api/admin/issue-key',{method:'POST', headers, body: JSON.stringify(payload)});
    const d = await r.json();
    document.getElementById('issueStatus').innerHTML = d.ok ? '<span class="ok">OK</span>' : '<span class="err">'+(d.error||'Error')+'</span>';
  }finally{ setBusy(btn,false,'Emitir'); }
});

document.getElementById('btnList').addEventListener('click', async ()=>{
  const btn = document.getElementById('btnList');
  const headers = authHeaders(); if(!headers){ return; }
  try{
    setBusy(btn,true,'Listar','Buscando...');
    const params = new URLSearchParams();
    const q = (document.getElementById('q').value||'').trim();
    const redeemed = document.getElementById('redeemed').value;
    const u = document.getElementById('u').value;
    if(q) params.set('q', q);
    if(redeemed!=='') params.set('redeemed', redeemed);
    if(u) params.set('university', u);
    const res = await fetch('/api/admin/issue-key?'+params.toString(), {headers});
    const data = await res.json();
    if(!data.ok || !Array.isArray(data.items) || data.items.length===0){ document.getElementById('listWrap').textContent='Sin resultados.'; return; }
    const rows = data.items.map(k=>`<tr>
      <td><small class="code">${k.code}</small></td>
      <td>${k.plan}</td>
      <td>${k.university}</td>
      <td>${new Date(k.expires_at).toLocaleString('es-PA', ${JSON.stringify(TZ_OPTS)})}</td>
      <td>${k.redeemed?'sí':'no'}</td>
      <td>${k.redeemed_by_email||'-'}</td>
      <td>${new Date(k.created_at).toLocaleString('es-PA', ${JSON.stringify(TZ_OPTS)})}</td>
    </tr>`).join('');
    document.getElementById('listWrap').innerHTML = '<table><thead><tr><th>Code</th><th>Plan</th><th>Univ</th><th>Expira</th><th>Redimida</th><th>Email</th><th>Creada</th></tr></thead><tbody>'+rows+'</tbody></table>';
  }finally{ setBusy(btn,false,'Listar'); }
});

/* ===== QUESTIONS ===== */
const choicesWrap = document.getElementById('choices');
function addChoice(val=''){
  const i = choicesWrap.querySelectorAll('input.choice').length;
  if(i>=6) return;
  const div = document.createElement('div'); div.className='row';
  div.innerHTML = `<input class="choice" placeholder="Opción ${i}" value="${(val||'').replace(/"/g,'&quot;')}"><button type="button" class="btnDel">X</button>`;
  div.querySelector('.btnDel').addEventListener('click', ()=>div.remove());
  choicesWrap.appendChild(div);
}
['','','',''].forEach(()=>addChoice(''));
document.getElementById('btnAddChoice').addEventListener('click', ()=>addChoice(''));

document.getElementById('btnSaveQuestion').addEventListener('click', async ()=>{
  const btn = document.getElementById('btnSaveQuestion');
  const headers = authHeaders(); if(!headers){ document.getElementById('q_status').innerHTML='<span class="err">Falta ADMIN_TOKEN</span>'; return; }
  const id = (document.getElementById('q_id').value||'').trim() || null;
  const topic = document.getElementById('q_topic').value;
  const prompt = (document.getElementById('q_prompt').value||'').trim();
  const choices = Array.from(document.querySelectorAll('input.choice')).map(i=>i.value.trim()).filter(Boolean);
  const answer_index = parseInt(document.getElementById('q_answer_index').value,10) || 0;
  const difficulty = (document.getElementById('q_difficulty').value||'').trim() || null;
  const explanation = (document.getElementById('q_explanation').value||'').trim() || null;
  const active = document.getElementById('q_active').checked;

  if(!prompt || choices.length<2 || choices.length>6 || answer_index<0 || answer_index>=choices.length){
    document.getElementById('q_status').innerHTML='<span class="err">Revisa pregunta y opciones.</span>'; return;
  }

  try{
    setBusy(btn,true,'Guardar pregunta','Guardando...');
    const res = await fetch('/api/admin/questions-upsert', {
      method: id ? 'PUT':'POST', headers, body: JSON.stringify({ id, topic, prompt, choices, answer_index, difficulty, active, explanation })
    });
    const data = await res.json();
    document.getElementById('q_status').innerHTML = data.ok ? '<span class="ok">Guardado. ID: '+data.id+'</span>' : '<span class="err">'+(data.error||'Error')+'</span>';
    if(data.ok) document.getElementById('q_id').value = data.id || '';
  }finally{ setBusy(btn,false,'Guardar pregunta'); }
});

document.getElementById('btnListQ').addEventListener('click', async ()=>{
  const btn = document.getElementById('btnListQ');
  const headers = authHeaders(); if(!headers){ document.getElementById('q_list').innerHTML='<span class="err">Falta ADMIN_TOKEN</span>'; return; }
  try{
    setBusy(btn,true,'Listar preguntas','Buscando...');
    const params = new URLSearchParams();
    const t = document.getElementById('f_topic').value;
    const q = (document.getElementById('f_q').value||'').trim();
    const a = document.getElementById('f_active').value;
    if(t) params.set('topic', t);
    if(q) params.set('q', q);
    if(a) params.set('active', a);
    const res = await fetch('/api/admin/questions-list?'+params.toString(), {headers});
    const data = await res.json();
    if(!data.ok || !Array.isArray(data.items) || data.items.length===0){ document.getElementById('q_list').textContent='Sin resultados.'; return; }
    const rows = data.items.map(item=>`<tr>
      <td><small class="code">${item.id}</small></td>
      <td>${item.topic}</td>
      <td>${item.prompt}</td>
      <td>${item.choices.map((c,i)=> (i===item.answer_index?'<strong>'+c+'</strong>':c)).join('<br>')}</td>
      <td>${item.difficulty||'-'}</td>
      <td>${item.active?'sí':'no'}</td>
      <td>${new Date(item.created_at).toLocaleString('es-PA', ${JSON.stringify(TZ_OPTS)})}</td>
      <td><button type="button" data-id="${item.id}" class="btnLoad">cargar</button></td>
    </tr>`).join('');
    document.getElementById('q_list').innerHTML = '<table><thead><tr><th>ID</th><th>Tema</th><th>Pregunta</th><th>Opciones</th><th>Dif.</th><th>Activa</th><th>Creada</th><th>Editar</th></tr></thead><tbody>'+rows+'</tbody></table>';

    document.querySelectorAll('.btnLoad').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.getAttribute('data-id');
        const item = data.items.find(x=>x.id===id);
        if(!item) return;
        document.getElementById('q_id').value = item.id;
        document.getElementById('q_topic').value = item.topic;
        document.getElementById('q_prompt').value = item.prompt;
        choicesWrap.innerHTML=''; item.choices.forEach(c=>addChoice(c));
        document.getElementById('q_answer_index').value = item.answer_index;
        document.getElementById('q_difficulty').value = item.difficulty||'';
        document.getElementById('q_explanation').value = item.explanation||'';
        document.getElementById('q_active').checked = !!item.active;
        window.scrollTo({top:0,behavior:'smooth'});
      });
    });

  }finally{ setBusy(btn,false,'Listar preguntas'); }
});

/* ===== YAPPY ===== */
let SELECTED_REQ_ID = null;

document.getElementById('btnYList').addEventListener('click', async ()=>{
  const btn = document.getElementById('btnYList');
  const headers = authHeaders(); if(!headers){ return; }
  try{
    setBusy(btn,true,'Refrescar','Buscando...');
    const status = document.getElementById('ystatus').value;
    const res = await fetch('/api/admin/yappy-requests?status='+status, {headers});
    const data = await res.json();
    if(!data.ok || !Array.isArray(data.items) || data.items.length===0){ document.getElementById('ylist').textContent='Sin resultados.'; return; }
    const rows = data.items.map(it=>`<tr>
      <td>${new Date(it.created_at).toLocaleString('es-PA', ${JSON.stringify(TZ_OPTS)})}</td>
      <td>${it.email}<br><small>${it.name||''}</small></td>
      <td>${it.university}</td>
      <td>${it.plan}</td>
      <td>${(it.amount_cents/100).toFixed(2)+' '+it.currency}</td>
      <td>${it.reference||'-'}</td>
      <td>${it.status}${it.issued_code?('<br><small class="code">'+it.issued_code+'</small>'):''}</td>
      <td><button type="button" data-id="${it.id}" class="btnView">ver</button></td>
    </tr>`).join('');
    document.getElementById('ylist').innerHTML = '<table><thead><tr><th>Creada</th><th>Email</th><th>Univ</th><th>Plan</th><th>Monto</th><th>Ref</th><th>Status</th><th>Comprobante</th></tr></thead><tbody>'+rows+'</tbody></table>';

    document.querySelectorAll('.btnView').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const id = b.getAttribute('data-id'); SELECTED_REQ_ID=id;
        const r = await fetch('/api/admin/yappy-proof?id='+id, {headers});
        const d = await r.json();
        if(d.ok && d.proof_data_url){
          document.getElementById('yproof').innerHTML = '<img src="'+d.proof_data_url+'" style="max-width:480px;border:1px solid #e2e8f0;border-radius:12px">';
        }else{
          document.getElementById('yproof').textContent = 'Sin comprobante.';
        }
        document.getElementById('yStatus').textContent = 'Solicitud seleccionada: '+id;
      });
    });
  }finally{ setBusy(btn,false,'Refrescar'); }
});

document.getElementById('btnApprove').addEventListener('click', async ()=>{
  const headers = authHeaders(); if(!headers){ return; }
  if(!SELECTED_REQ_ID){ document.getElementById('yStatus').innerHTML='<span class="err">Selecciona una solicitud.</span>'; return; }
  const r = await fetch('/api/admin/yappy-approve', {method:'POST', headers, body: JSON.stringify({ request_id: SELECTED_REQ_ID })});
  const d = await r.json();
  document.getElementById('yStatus').innerHTML = d.ok ? '<span class="ok">Aprobada. KEY: '+d.code+'</span>' : '<span class="err">'+(d.error||'Error')+'</span>';
});

document.getElementById('btnReject').addEventListener('click', async ()=>{
  const headers = authHeaders(); if(!headers){ return; }
  if(!SELECTED_REQ_ID){ document.getElementById('yStatus').innerHTML='<span class="err">Selecciona una solicitud.</span>'; return; }
  const reason = prompt('Motivo (opcional):','');
  const r = await fetch('/api/admin/yappy-reject', {method:'POST', headers, body: JSON.stringify({ request_id: SELECTED_REQ_ID, notes: reason||'' })});
  const d = await r.json();
  document.getElementById('yStatus').innerHTML = d.ok ? '<span class="ok">Rechazada.</span>' : '<span class="err">'+(d.error||'Error')+'</span>';
});
</script>
</body>
</html>
