<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IngresoU – Comprensión Lectora</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;max-width:900px;margin:0 auto;padding:24px;background:#f8fafc;color:#0f172a}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .card{background:#fff;border:1px solid #e2e8f0;border-radius:12px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.04);margin:12px 0}
    .muted{color:#475569}
    nav a{margin-right:12px}
    button{padding:10px 14px;border:0;border-radius:10px;background:#0ea5e9;color:#fff;font-weight:600;cursor:pointer}
    button:disabled{background:#94a3b8;cursor:not-allowed}
    label{display:block;margin:6px 0}
  </style>
</head>
<body>
<header>
  <h1>IngresoU</h1>
  <nav>
    <a href="/index.html">Inicio</a>
    <a href="/premium.html">Premium</a>
    <a href="/leaderboard.html">Ranking</a>
  </nav>
</header>

<div class="card">
  <h2>Práctica – Comprensión Lectora</h2>
  <div id="quizWrap" class="muted">Cargando preguntas...</div>
  <div class="card">
    <button id="btnSubmit" disabled>Enviar respuestas</button>
    <p id="result" class="muted"></p>
  </div>
</div>

<script>
const TOPIC = 'lectura';
const FALLBACK = [
  {q:'La idea principal de un texto es...', choices:['Un ejemplo','El detalle menor','Lo más importante que comunica','La cita'], a:2},
  {q:'Sinónimo de "feliz"', choices:['Triste','Contento','Serio','Sombrío'], a:1},
  {q:'Inferir requiere...', choices:['Memorizar','Deducir lo implícito','Ignorar el contexto','Traducir'], a:1},
  {q:'"Por lo tanto" indica...', choices:['Causa','Consecuencia','Contraste','Definición'], a:1},
  {q:'Antónimo de "oscuro"', choices:['Tenue','Luminoso','Sombrío','Apagado'], a:1},
  {q:'Un párrafo está formado por...', choices:['Palabras sueltas','Oraciones relacionadas','Sílabas','Citas'], a:1},
  {q:'"Explícito" significa...', choices:['Dicho claramente','Sugiere','Oculto','Implicado'], a:0},
  {q:'Moraleja suele aparecer en...', choices:['Fábulas','Noticias','Manuales','Enciclopedias'], a:0},
  {q:'"Según el texto" exige...', choices:['Opinión personal','Dato textual','Hipótesis creativa','Resumen libre'], a:1},
  {q:'Onomatopeya es...', choices:['Imitación de sonidos','Figura de imagen','Tropo numérico','Metáfora visual'], a:0},
];

function getSession(){
  const email = localStorage.getItem('ingresou_email')||'';
  const code  = localStorage.getItem('ingresou_key')||'';
  return {email, code};
}

let startTime = Date.now();
let questions = [];

async function loadQuestions(){
  const sess = getSession();
  if(!sess.email || !sess.code) location.href='/index.html';
  try {
    const res = await fetch('/api/generate-questions', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({topic: TOPIC, count: 10})
    });
    const data = await res.json();
    if(Array.isArray(data.questions)) questions = data.questions;
    else questions = FALLBACK.map(x=>({question:x.q, choices:x.choices, answer_index:x.a}));
  } catch(e) {
    questions = FALLBACK.map(x=>({question:x.q, choices:x.choices, answer_index:x.a}));
  }
  renderQuiz();
}

function renderQuiz(){
  const wrap = document.getElementById('quizWrap');
  const items = questions.map(function(q, i){
    const opts = q.choices.map(function(c,j){
      return '<label><input type="radio" name="q'+i+'" value="'+j+'"> '+c+'</label>';
    }).join('<br>');
    return '<div class="card"><strong>'+(i+1)+'.</strong> '+q.question+'<div style="margin-top:8px">'+opts+'</div></div>';
  }).join('');
  wrap.innerHTML = items;
  document.getElementById('btnSubmit').disabled = false;
}

async function submit(){
  const btn = document.getElementById('btnSubmit');
  if(btn.disabled) return;
  btn.disabled = true;
  btn.textContent = 'Enviando...';

  const dur = Math.round((Date.now()-startTime)/1000);
  let score = 0;
  questions.forEach(function(q,i){
    const sel = document.querySelector('input[name="q'+i+'"]:checked');
    if(sel && Number(sel.value) === Number(q.answer_index)) score++;
  });

  const sess = getSession();
  try{
    await fetch('/api/submit-score', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({email: sess.email, code: sess.code, topic: TOPIC, score: score, duration: dur})
    });
  }catch(e){}

  document.getElementById('result').innerHTML = 'Puntaje: <strong>'+score+'/10</strong> en '+dur+'s';
  btn.textContent = 'Enviado';
}

document.getElementById('btnSubmit').addEventListener('click', submit);
loadQuestions();
</script>
</body>
</html>

