<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>IngresoU ‚Äî Prep√°rate para UTP y Universidad de Panam√°</title>
  <link rel="stylesheet" href="/assets/styles.css"/>
  <meta name="color-scheme" content="dark light"/>
</head>
<body>
<header class="header">
  <div class="container row">
    <div class="brand">IngresoU <span class="badge">Panam√°</span></div>
    <nav class="nav">
      <a href="/index.html">Inicio</a>
      <a href="/premium.html">Premium</a>
      <a href="/leaderboard.html">Ranking</a>
      <a href="/exam.html">Examen</a>
    </nav>
  </div>
</header>

<main class="container">
  <!-- HERO -->
  <section class="hero">
    <div class="card pad">
      <h1 class="h1">Tu pase a la universidad ‚Äî <span class="accent">PAA, PCA y PCG</span></h1>
      <p class="p">Simuladores oficiales, pr√°cticas inteligentes y ranking. Pensado para Panam√° (America/Panama) y optimizado para UTP y Universidad de Panam√°.</p>
      <div class="chips">
        <span class="chip">Panam√° ¬∑ UTP ¬∑ UP</span>
        <span class="chip">Simuladores cronometrados</span>
        <span class="chip">Bancos actualizados</span>
      </div>

      <div class="section">
        <div class="row">
          <!-- Atajos a simuladores (requerir√°n sesi√≥n; si no, scrollean al login) -->
          <button class="btn brand" data-preset="paa">PAA (UTP) ‚Äî 2 secciones</button>
          <button class="btn" data-preset="pca">PCA (UP) ‚Äî 2 secciones</button>
          <button class="btn" data-preset="pcg">PCG (UP) ‚Äî 4 secciones</button>
          <a class="btn ghost" href="/practice-algebra.html">√Ålgebra</a>
          <a class="btn ghost" href="/practice-logico.html">L√≥gico</a>
          <a class="btn ghost" href="/practice-lectura.html">Lectura</a>
        </div>
        <p class="inline-note">Consejo: si est√°s en m√≥vil, usa aud√≠fonos y modo ‚ÄúNo molestar‚Äù.</p>
      </div>
    </div>

    <!-- Login r√°pido (funciona incluso sin ui.js) -->
    <div class="card pad">
      <h3>Acceso r√°pido</h3>
      <p class="p">Entra con tu <b>KEY</b> y correo. Si tu KEY no est√° redimida, la activamos autom√°ticamente.</p>
      <form id="login-form" class="section">
        <label>Correo</label>
        <input id="login-email" class="input" type="email" placeholder="tu@correo.com" required/>
        <div style="height:10px"></div>
        <label>KEY</label>
        <input id="login-code" class="input" type="text" placeholder="UTP-ABCD-1234" required/>
        <div style="height:14px"></div>
        <button class="btn brand" type="submit">Entrar</button>
        <div id="login-out" class="inline-note"></div>
      </form>

      <div class="section">
        <table class="simple">
          <tr><td>¬øNo tienes KEY?</td><td><button class="btn brand" data-buy="mensual">Comprar plan Mensual</button></td></tr>
          <tr><td>¬øTe lleg√≥ una KEY por WhatsApp?</td><td><a class="btn" href="/activate.html">Activar por link</a></td></tr>
          <tr><td>Soporte</td><td><a class="btn ghost" href="mailto:soporte@ingresou.com">soporte@ingresou.com</a></td></tr>
        </table>
      </div>
    </div>
  </section>

  <!-- PLANES -->
  <section class="section">
    <h3>Planes</h3>
    <div class="grid-3">
      <div class="card pad plan-card">
        <div class="plan-badge">Recomendado</div>
        <h4>Mensual</h4>
        <div class="price" id="price-mensual">‚Äî</div>
        <p class="sub">Acceso completo por 30 d√≠as</p>
        <ul class="p">
          <li>‚úî Simuladores PAA, PCA, PCG</li>
          <li>‚úî Pr√°cticas por m√≥dulo</li>
          <li>‚úî Ranking nacional</li>
        </ul>
        <button class="btn brand" data-buy="mensual">Comprar</button>
      </div>

      <div class="card pad plan-card">
        <h4>Trimestral</h4>
        <div class="price" id="price-trimestral">‚Äî</div>
        <p class="sub">Ahorra m√°s con 3 meses</p>
        <ul class="p">
          <li>‚úî Todo lo del Mensual</li>
          <li>‚úî Retro y avances</li>
          <li>‚úî Soporte prioritario</li>
        </ul>
        <button class="btn brand" data-buy="trimestral">Comprar</button>
      </div>

      <div class="card pad plan-card">
        <h4>Anual</h4>
        <div class="price" id="price-anual">‚Äî</div>
        <p class="sub">12 meses de acceso</p>
        <ul class="p">
          <li>‚úî Todo lo del Trimestral</li>
          <li>‚úî Acceso a nuevos bancos</li>
          <li>‚úî Bonos exclusivos</li>
        </ul>
        <button class="btn brand" data-buy="anual">Comprar</button>
      </div>
    </div>
  </section>

  <footer class="footer">
    <div class="row">
      <span>¬© IngresoU. Hecho para Panam√° üáµüá¶</span>
      <span class="inline-note">Versi√≥n MVP</span>
    </div>
  </footer>
</main>

<!-- MODAL COMPRA (lo usa ui.js, pero hay fallback si no carga) -->
<div class="modal-backdrop" style="display:none" onclick="(window.IngresoU&&IngresoU.closeBuy)?IngresoU.closeBuy():0">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="head">
      <strong>Finaliza tu compra con Yappy</strong>
      <button class="btn ghost" onclick="(window.IngresoU&&IngresoU.closeBuy)?IngresoU.closeBuy():0">Cerrar</button>
    </div>
    <div class="body">
      <div class="kv"><div class="k">Plan</div><div class="v" id="buy-plan">‚Äî</div></div>
      <div class="kv"><div class="k">Monto</div><div class="v" id="buy-amount">‚Äî</div></div>
      <div class="kv"><div class="k">Comercio</div><div class="v" id="buy-display">IngresoU</div></div>
      <div class="kv"><div class="k">Tu correo</div><div class="v"><input id="buy-email" class="input" placeholder="tu@correo.com"/></div></div>
      <p class="inline-note">Tras pagar, te enviamos tu KEY o link de activaci√≥n por WhatsApp/Correo.</p>
    </div>
    <div class="foot">
      <a id="buy-wa" class="btn brand" target="_blank" rel="noopener">Pagar / confirmar por WhatsApp</a>
    </div>
  </div>
</div>

<!-- JS principal (si carga, usa modal y maneja presets con login) -->
<script src="/assets/ui.js"></script>

<!-- FALLBACK universal: comprar y presets aunque /assets/ui.js falle -->
<script>
(async function(){
  /* ========== CONFIG p√∫blica (precios/moneda/tel√©fono) ========== */
  let CFG = { currency:'PAB', yappy_phone:'+50760000000',
              prices:{ mensual_cents:999, trimestral_cents:2499, anual_cents:6900 } };
  try{
    const r = await fetch('/api/public-config'); const j = await r.json();
    if(j && j.ok){ CFG = j; }
  }catch(_){ /* fallback */ }

  const phone = (CFG.yappy_phone || '+50760000000').replace(/[^\d]/g,'');
  const p = CFG.prices||{};
  const fmt = (c)=> (c/100).toLocaleString('es-PA',{style:'currency',currency:CFG.currency||'PAB'});

  // Render de precios (por si ui.js no lleg√≥ a hacerlo)
  const m=document.getElementById('price-mensual'); if(m) m.textContent=fmt(p.mensual_cents||0);
  const t=document.getElementById('price-trimestral'); if(t) t.textContent=fmt(p.trimestral_cents||0);
  const a=document.getElementById('price-anual'); if(a) a.textContent=fmt(p.anual_cents||0);

  /* ========== LOGIN inline (independiente de ui.js) ========== */
  async function quickLogin(e){
    e.preventDefault?.();
    const email=(document.getElementById('login-email')?.value||'').trim().toLowerCase();
    const code =(document.getElementById('login-code')?.value||'').trim().toUpperCase();
    const out=document.getElementById('login-out');
    const say=(m,bad=false)=>{ if(out){ out.textContent=m; out.className='inline-note '+(bad?'bad':'good'); } };

    if(!email||!code) return say('Completa correo y KEY.',true);

    try{
      const send = async (url, body) => {
        const r = await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
        return r.json();
      };
      let r = await send('/api/get-subscription',{ email, code });
      if(!r.ok && r.error==='NOT_REDEEMED'){
        const rr=await send('/api/redeem-key',{ email, code });
        if(rr.ok){ r = await send('/api/get-subscription',{ email, code }); }
      }
      if(r.ok && r.subscription){
        const s=r.subscription;
        localStorage.setItem('ingresou_email', email);
        localStorage.setItem('ingresou_key', code);
        localStorage.setItem('ingresou_plan', s.plan||'mensual');
        localStorage.setItem('ingresou_university', s.university||'');
        localStorage.setItem('ingresou_expires_at', s.expires_at||'');
        say('¬°Listo! Redirigiendo‚Ä¶');
        const next=new URLSearchParams(location.search).get('next');
        setTimeout(()=> location.href= next || '/premium.html', 300);
      } else {
        say(r?.error||'Error de acceso', true);
      }
    }catch(err){
      say('No se pudo conectar. Intenta de nuevo.', true);
    }
  }
  const f=document.getElementById('login-form');
  if(f){ f.addEventListener('submit', quickLogin); }

  /* ========== BUY universal: con ui.js (modal) o directo a WhatsApp ========== */
  function waLink(plan){
    const cents = plan==='anual' ? p.anual_cents : plan==='trimestral' ? p.trimestral_cents : p.mensual_cents;
    const amount = fmt(cents||0);
    const email=(localStorage.getItem('ingresou_email')||'').toLowerCase();
    const msg = encodeURIComponent(`Hola, quiero comprar el plan ${plan.toUpperCase()} (${amount}) para IngresoU. Mi correo: ${email||'(escribe tu correo aqu√≠)'}`);
    return `https://wa.me/${phone}?text=${msg}`;
  }
  document.querySelectorAll('[data-buy]').forEach(el=>{
    el.addEventListener('click', ()=>{
      const plan = el.getAttribute('data-buy');
      if(window.IngresoU && IngresoU.openBuy){
        IngresoU.openBuy(plan); // Modal bonito
      } else {
        window.open(waLink(plan), '_blank'); // Fallback directo
      }
    });
  });

  /* ========== PRESETS universal: si no hay sesi√≥n, scrollea al login ========== */
  function haveSession(){ return !!(localStorage.getItem('ingresou_email') && localStorage.getItem('ingresou_key')); }
  function scrollToLogin(){ const form=document.getElementById('login-form'); if(form){ form.scrollIntoView({behavior:'smooth',block:'start'}); const c=document.getElementById('login-code'); c&&c.focus(); } }
  document.querySelectorAll('[data-preset]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const mode=btn.getAttribute('data-preset');
      if(haveSession()){ location.href=`/exam.html?mode=${encodeURIComponent(mode)}`; }
      else { scrollToLogin(); }
    });
  });

})();
</script>
  <script>
/* ==== FALLBACK DEFINITIVO PARA COMPRAR (funciona s√≠ o s√≠) ==== */
(function(){
  // Fallbacks hardcodeados por si /api/public-config o ui.js fallan
  const DEF_PHONE   = '+50760000000';
  const DEF_CURR    = 'PAB';
  const DEF_PRICES  = { mensual_cents: 999, trimestral_cents: 2499, anual_cents: 6900 };

  // Helper: formatea B/. a partir de cents
  function money(cents, curr){
    return (Number(cents||0)/100).toLocaleString('es-PA',{ style:'currency', currency: curr || DEF_CURR });
  }
  // Helper: construye link de WhatsApp
  function buildWA(plan, curr, prices, phone){
    const cents = plan === 'anual' ? (prices.anual_cents||0)
                : plan === 'trimestral' ? (prices.trimestral_cents||0)
                : (prices.mensual_cents||0);
    const amount = money(cents, curr);
    const email  = (localStorage.getItem('ingresou_email')||'').toLowerCase();
    const msg = encodeURIComponent(
      `Hola, quiero comprar el plan ${plan.toUpperCase()} (${amount}) para IngresoU. `+
      `Mi correo: ${email || '(escribe tu correo aqu√≠)'}`
    );
    const cleanPhone = (phone||DEF_PHONE).replace(/[^\d]/g,'');
    return `https://wa.me/${cleanPhone}?text=${msg}`;
  }

  // Leemos config p√∫blica si est√° disponible (no bloquea si falla)
  let CFG = { currency: DEF_CURR, yappy_phone: DEF_PHONE, prices: DEF_PRICES };
  (async ()=>{
    try{
      const r = await fetch('/api/public-config', {cache:'no-store'});
      const j = await r.json();
      if (j && j.ok) CFG = j;
    } catch(_) { /* seguimos con defaults */ }
  })();

  // DELEGACI√ìN DE EVENTOS: captura clicks en cualquier [data-buy]
  document.addEventListener('click', function(ev){
    const tgt = ev.target.closest('[data-buy]');
    if(!tgt) return;

    ev.preventDefault();
    const plan = tgt.getAttribute('data-buy') || 'mensual';

    // Si ui.js carg√≥ y expuso modal ‚Üí √∫salo
    if (window.IngresoU && typeof IngresoU.openBuy === 'function') {
      IngresoU.openBuy(plan);
      return;
    }
    // Fallback garantizado ‚Üí ir directo a WhatsApp en la MISMA pesta√±a (sin bloqueos)
    const url = buildWA(plan, CFG.currency, CFG.prices||DEF_PRICES, CFG.yappy_phone);
    window.location.href = url;
  }, {capture:true});
})();
</script>

</body>
</html>

