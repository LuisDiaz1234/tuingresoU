<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IngresoU ‚Äî Simulador</title>
  <style>
    :root{
      --bg:#0c111b; --card:#111827; --muted:#9aa4b2; --text:#e6edf3; --brand:#22c55e;
      --chip:#0b1220; --chipActive:#1f2937; --primary:#3b82f6; --primary-2:#1d4ed8;
      --ok:#34d399; --warn:#f59e0b; --err:#ef4444; --pill:#0b1730;
      --grad1:#0e1726; --grad2:#0b1933; --q:#101726;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,Segoe UI,Roboto,Arial,sans-serif}
    a{color:#9bd1ff;text-decoration:none}
    .wrap{max-width:1100px;margin:0 auto;padding:24px 16px 56px}

    /* Header */
    .top{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{display:inline-grid;place-items:center;width:36px;height:36px;border-radius:10px;
      background:linear-gradient(135deg,#0ea5e9, #22c55e)}
    .logo b{color:#0b1220}
    .brand h1{font-size:18px;margin:0}
    nav{display:flex;gap:14px;align-items:center}
    nav a{padding:8px 10px;border-radius:8px;color:#cfe7ff}
    nav a.active{background:#0d1b2a;color:#fff}
    .badges{display:flex;gap:8px}
    .badge{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;background:#0a1324;color:#a9c9ff;font-size:13px}

    /* Blocks */
    .card{background:linear-gradient(180deg,var(--grad1),var(--grad2));border:1px solid #1f2937;border-radius:16px;padding:18px;margin:14px 0}
    .card h2{margin:0 0 8px 0}

    .chips{display:flex;gap:10px;flex-wrap:wrap}
    .chip{background:var(--chip);border:1px solid #1f2937;color:#bcd2ff;border-radius:999px;padding:10px 14px;font-weight:600;cursor:pointer}
    .chip.active{background:var(--chipActive);color:#fff;border-color:#2a3a58}
    .chip:hover{transform:translateY(-1px)}

    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .pill{display:inline-flex;align-items:center;gap:6px;background:#0f1a30;border:1px solid #22314f;border-radius:999px;padding:6px 10px;color:#a5c7ff;font-size:13px}
    .control{display:flex;flex-direction:column;gap:6px}
    select,input[type="number"]{background:#0d1424;color:#dbe8ff;border:1px solid #23314b;border-radius:10px;padding:10px 12px;min-width:160px}
    .btn{background:linear-gradient(180deg,var(--primary),var(--primary-2));border:1px solid #2748a8;border-radius:10px;color:#fff;font-weight:700;letter-spacing:.2px;padding:12px 16px;cursor:pointer}
    .btn:hover{filter:brightness(1.1)}
    .btn:active{transform:translateY(1px)}

    /* Messages */
    .msg{margin-top:10px}
    .msg a{color:#9bd1ff;text-decoration:underline}
    .msg.ok{color:var(--ok)} .msg.warn{color:#ffd166} .msg.error{color:#ff8b8b}

    /* Exam panel */
    .sec{background:var(--card);border:1px solid #1f2937;border-radius:14px;padding:14px;margin:14px 0}
    .sec-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .sec h3{margin:0;font-size:17px}
    .q-card{background:var(--q);border:1px solid #1a2641;border-radius:12px;padding:14px;margin:10px 0}
    .q-title{font-weight:700;margin-bottom:8px}
    .q-opts{display:grid;gap:8px}
    .opt{display:flex;gap:8px;align-items:flex-start}
    .opt input{margin-top:3px}

    /* Footer label */
    .helper{color:var(--muted);font-size:13px;padding:8px 10px;border:1px dashed #2c3b5a;border-radius:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="top">
      <div class="brand">
        <span class="logo"><b>U</b></span>
        <h1>IngresoU</h1>
      </div>
      <nav>
        <a href="/index.html">Inicio</a>
        <a href="/premium.html">Premium</a>
        <a href="/leaderboard.html">Ranking</a>
        <a href="/exam.html" class="active">Examen</a>
      </nav>
      <div class="badges">
        <span class="badge">üî• Racha: <b id="streakVal">1</b></span>
        <span class="badge">‚≠ê XP: <b id="xpVal">0</b></span>
      </div>
    </header>

    <!-- SIMULADORES -->
    <section class="card">
      <h2>Simuladores oficiales</h2>
      <div class="chips">
        <button class="chip" data-preset="paa">PAA (UTP) ‚Äî 2 secciones, 60+60 min</button>
        <button class="chip" data-preset="pca">PCA (UP) ‚Äî 2 secciones, 120 min</button>
        <button class="chip" data-preset="pcg">PCG (UP) ‚Äî 4 secciones, 120 min</button>
      </div>
    </section>

    <!-- PERSONALIZADO -->
    <section class="card">
      <h2>Examen personalizado</h2>
      <div class="row" style="margin-bottom:8px">
        <span class="pill">Tiempo total: <b data-total>120:00</b></span>
        <span class="pill">Tiempo restante: <b data-remaining>‚Äî</b></span>
      </div>
      <div class="row">
        <div class="control">
          <label>Dificultad</label>
          <select id="diffSelect">
            <option value="easy">Baja</option>
            <option value="medium" selected>Media</option>
            <option value="hard">Alta</option>
          </select>
        </div>
        <div class="control">
          <label>Preguntas por secci√≥n</label>
          <input id="countPerSection" type="number" min="3" step="1" value="30" />
        </div>
        <div class="control" style="margin-top:22px">
          <button id="btnGenerate" class="btn">Generar examen</button>
        </div>
      </div>
      <div id="examMsg" class="msg"></div>
    </section>

    <!-- AQU√ç SE RENDERIZA EL EXAMEN -->
    <div id="examPanel"></div>

    <p class="helper">¬øBanco insuficiente? Baja ‚ÄúPreguntas por secci√≥n‚Äù o agrega m√°s √≠tems en <code>public.questions</code>.</p>
  </div>

  <script>
(() => {
  // ---------- Short DOM helpers ----------
  const qs  = (s,el=document)=>el.querySelector(s);
  const qsa = (s,el=document)=>[...el.querySelectorAll(s)];
  const fmt = n=>String(n).padStart(2,'0');

  // ---------- Elements ----------
  const chips       = qsa('[data-preset]');
  const diffSel     = qs('#diffSelect');
  const countInput  = qs('#countPerSection');
  const btnGenerate = qs('#btnGenerate');
  const totalTimeEl = qs('[data-total]');
  const remainEl    = qs('[data-remaining]');
  const panel       = qs('#examPanel');
  const msgBox      = qs('#examMsg');

  // ---------- State ----------
  let mode = new URLSearchParams(location.search).get('mode') || 'paa';
  let timerId = null, deadline = null;

  // ---------- Presets oficiales ----------
  const PRESETS = {
    paa: {
      label:'PAA', time:120, defaultCount:30,
      sections: [
        { key:'algebra', title:'Matem√°ticas (√Ålgebra)', topic:'algebra' },
        { key:'lectura', title:'Lectura',               topic:'lectura' },
      ]
    },
    pca: {
      label:'PCA', time:120, defaultCount:50,
      sections: [
        { key:'lectura', title:'Espa√±ol (Comprensi√≥n/Gram√°tica)', topic:'lectura' },
        { key:'algebra', title:'Matem√°ticas',                     topic:'algebra' },
      ]
    },
    pcg: {
      label:'PCG', time:120, defaultCount:25,
      sections: [
        { key:'biologia', title:'Biolog√≠a',    topic:'biologia' },
        { key:'quimica',  title:'Qu√≠mica',     topic:'quimica'  },
        { key:'fisica',   title:'F√≠sica',      topic:'fisica'   },
        { key:'algebra',  title:'Matem√°ticas', topic:'algebra'  },
      ]
    }
  };

  // ---------- UI Utils ----------
  function showMsg(html, tone='info'){
    msgBox.innerHTML = html;
    msgBox.className = 'msg ' + (tone==='error' ? 'error' : tone==='warn' ? 'warn' : 'ok');
  }
  function clearMsg(){ msgBox.innerHTML=''; msgBox.className='msg'; }

  function resetTimer(){
    if (timerId) clearInterval(timerId);
    timerId = null; deadline = null;
    if (remainEl) remainEl.textContent = '‚Äî';
  }
  function startTimer(mins){
    resetTimer();
    deadline = Date.now() + mins*60*1000;
    timerId = setInterval(()=>{
      const left = Math.max(0, deadline - Date.now());
      const m = Math.floor(left/60000), s = Math.floor((left%60000)/1000);
      if (remainEl) remainEl.textContent = `${fmt(m)}:${fmt(s)}`;
      if (left<=0){ clearInterval(timerId); timerId=null; }
    }, 250);
  }

  function setPreset(newMode){
    mode = newMode;
    const p = PRESETS[mode] || PRESETS.paa;
    if (totalTimeEl) totalTimeEl.textContent = `${fmt(p.time)}:00`;
    if (countInput)  countInput.value      = p.defaultCount;
    chips.forEach(c => c.classList.toggle('active', c.dataset.preset === mode));
    clearMsg(); resetTimer(); panel.innerHTML='';
  }

  // ---------- Render ----------
  function renderExam(sections){
    panel.innerHTML = sections.map(sec => {
      const qs = sec.questions.map((q, i)=>{
        const opts = q.choices.map((c, j)=>`
          <label class="opt">
            <input type="radio" name="q-${sec.key}-${i}" value="${j}">
            <span>${c}</span>
          </label>
        `).join('');
        return `<div class="q-card">
          <div class="q-title">${i+1}. ${q.prompt}</div>
          <div class="q-opts">${opts}</div>
        </div>`;
      }).join('');
      return `<section class="sec">
        <div class="sec-head"><h3>${sec.title}</h3><span class="pill">${sec.questions.length} preguntas</span></div>
        ${qs}
      </section>`;
    }).join('');
  }

  // ---------- Backend (Plan A / Plan B) ----------
  async function callGenerateExamUnified(payload){
    try{
      const r = await fetch('/api/generate-exam', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if (r.status === 404) return { ok:false, error:'NOT_FOUND' };
      let dj; try{ dj = await r.json(); }catch{ return { ok:false, error:'BAD_JSON' }; }
      return dj;
    }catch{ return { ok:false, error:'NETWORK' }; }
  }

  // Plan B: llamar /api/generate-questions por t√≥pico, con degradaci√≥n de count si no alcanza
  async function callByTopics(preset, count, difficulty){
    const sections = [];
    for (const s of preset.sections){
      let want = count, got = null, lastErr = null;
      while (want >= 3){
        try{
          const r = await fetch('/api/generate-questions', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ topic: s.topic, count: want, difficulty })
          });
          const dj = await r.json();
          if (dj.ok && Array.isArray(dj.items) && dj.items.length){
            got = dj.items; break;
          }else{
            lastErr = dj.error || 'UNKNOWN';
            if (lastErr === 'INSUFFICIENT_BANK'){ want -= 2; continue; }
            break;
          }
        }catch(e){ lastErr = 'NETWORK'; break; }
      }
      if (!got){
        return { ok:false, error:'INSUFFICIENT_BANK', detail:`Secci√≥n "${s.title}" (tema: ${s.topic}). √öltimo error: ${lastErr||'‚Äî'}.` };
      }
      sections.push({ key:s.key, title:s.title, questions:got });
    }
    return { ok:true, sections };
  }

  async function generateExam(){
    clearMsg();
    const preset     = PRESETS[mode] || PRESETS.paa;
    const difficulty = diffSel.value || 'medium';
    const count      = parseInt(countInput.value || `${preset.defaultCount}`, 10) || preset.defaultCount;

    // Plan A
    let data = await callGenerateExamUnified({ mode, difficulty, count_per_section: count });
    if (data.ok){
      renderExam(data.sections || []);
      startTimer(preset.time);
      showMsg(`${preset.label} listo. ¬°√âxitos!`, 'ok');
      return;
    }

    // Plan B
    data = await callByTopics(preset, count, difficulty);
    if (!data.ok){
      if (data.error === 'INSUFFICIENT_BANK'){
        showMsg(`
          <b>Banco insuficiente</b> para <b>${preset.label}</b>.<br>
          ‚Ä¢ Baja ‚ÄúPreguntas por secci√≥n‚Äù (ej.: 8).<br>
          ‚Ä¢ O agrega m√°s filas en <code>public.questions</code> (tema faltante).<br>
          <small>${data.detail || ''}</small>
        `,'warn');
      }else{
        showMsg(`No se pudo generar el examen (Plan B): ${data.error || 'Error'}`,'error');
      }
      return;
    }
    renderExam(data.sections);
    startTimer(preset.time);
    showMsg(`${preset.label} listo (Plan B).`, 'ok');
  }

  // ---------- Events ----------
  chips.forEach(chip => chip.addEventListener('click', () => setPreset(chip.dataset.preset)));
  btnGenerate.addEventListener('click', generateExam);

  // Init
  setPreset(mode);
})();
  </script>
</body>
</html>


