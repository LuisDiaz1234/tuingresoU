<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Simulador ‚Äî IngresoU</title>
  <style>
    :root{
      --bg:#0b1220; --surface:#121a2b; --surface-2:#0f1726;
      --muted:#9db1d1; --text:#e8f0ff; --brand:#4f8cff; --brand-2:#7a5cff;
      --ok:#23c55e; --warn:#f59e0b; --err:#ef4444; --chip:#1b2440;
      --ring: rgba(79,140,255,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background: radial-gradient(1200px 800px at -10% -10%, #101836 0,#0b1220 60%), var(--bg);
      color:var(--text); font: 16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial;
    }
    a{color:var(--muted); text-decoration:none}
    a:hover{color:#fff}
    .nav{
      position:sticky; top:0; z-index:50; backdrop-filter: blur(8px);
      background:linear-gradient(0deg, rgba(11,18,32,.7), rgba(11,18,32,.7));
      border-bottom:1px solid rgba(255,255,255,.05);
    }
    .nav-inner{max-width:1100px;margin:auto;display:flex;align-items:center;gap:18px;padding:14px 18px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    .brand-badge{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--brand),var(--brand-2));display:grid;place-items:center;color:white;font-weight:800}
    .spacer{flex:1}
    .nav a.link{padding:8px 10px;border-radius:10px;color:var(--muted)}
    .nav a.link.active{background:rgba(79,140,255,.12); color:#fff; border:1px solid rgba(79,140,255,.35)}
    .chip{background:var(--chip); border:1px solid rgba(255,255,255,.06); padding:6px 10px;border-radius:999px; display:inline-flex; gap:8px; align-items:center; color:#cfe0ff}
    .chip i{filter: drop-shadow(0 0 8px rgba(79,140,255,.25))}
    main{max-width:1100px;margin:28px auto 60px;padding:0 18px}

    .card{background:linear-gradient(180deg,var(--surface), var(--surface-2)); border:1px solid rgba(255,255,255,.06); box-shadow: 0 10px 30px rgba(0,0,0,.35); border-radius:18px; overflow:hidden}
    .card .hdr{padding:18px 20px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;align-items:center;justify-content:space-between;gap:16px}
    .card .hdr h2{margin:0;font-size:20px}
    .card .body{padding:18px 20px}

    .presets{display:flex;gap:12px;flex-wrap:wrap}
    .pill{padding:10px 14px;border-radius:999px;border:1px solid rgba(255,255,255,.08); background:rgba(255,255,255,.04); cursor:pointer; color:#cfe0ff}
    .pill.active{background:linear-gradient(135deg, rgba(79,140,255,.22), rgba(122,92,255,.22)); border-color: var(--ring); color:#fff}

    .row{display:flex; gap:16px; flex-wrap:wrap}
    .grid {display:grid; grid-template-columns: 1fr auto; gap:12px}
    .control{display:flex;flex-direction:column;gap:10px; min-width:220px}
    label{font-size:13px;color:#b9c8e6}
    select,input{
      appearance:none; background:#0c1528; color:#eaf2ff; border:1px solid rgba(255,255,255,.12);
      padding:10px 12px; border-radius:12px; outline:none;
    }
    select:focus,input:focus{border-color:var(--ring); box-shadow:0 0 0 3px var(--ring)}
    .btn{
      background: linear-gradient(135deg, var(--brand), var(--brand-2)); border:0; color:#fff; padding:12px 16px;
      border-radius:12px; font-weight:700; cursor:pointer; transition: transform .08s ease, box-shadow .08s ease;
      box-shadow: 0 6px 20px rgba(79,140,255,.35);
    }
    .btn:hover{transform: translateY(-1px)}
    .btn:active{transform: translateY(0)}
    .btn-outline{background:transparent;border:1px solid rgba(255,255,255,.12); color:#eaf2ff}
    .meta{display:flex; gap:10px; align-items:center; color:#cfe0ff}
    .badge{background:var(--chip); padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.06)}
    .msg{margin-top:12px; font-size:14px; color:#cfe0ff}
    .msg.ok{color:#a7f3d0}
    .msg.warn{color:#fde68a}
    .msg.err{color:#fecaca}
    .divider{height:1px; background:rgba(255,255,255,.06); margin:16px 0}

    /* Render preguntas */
    .section{margin-top:18px}
    .section h3{margin:0 0 10px 0; font-size:18px}
    .q{
      background: rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.08);
      padding:16px; border-radius:14px; margin-bottom:12px;
    }
    .q .p{margin-bottom:10px}
    .choices{display:grid; gap:8px}
    .choice{display:flex; gap:10px; align-items:flex-start}
    .choice input{margin-top:3px}
    .hint{font-size:12px; color:#94a8c9}
    .footer-hint{padding:10px 14px; color:#9db1d1; font-size:13px; border:1px dashed rgba(255,255,255,.14); border-radius:12px; background: rgba(255,255,255,.02)}
  </style>
</head>
<body>
  <header class="nav">
    <div class="nav-inner">
      <div class="brand">
        <div class="brand-badge">U</div> IngresoU
      </div>
      <a class="link" href="/index.html">Inicio</a>
      <a class="link" href="/premium.html">Premium</a>
      <a class="link" href="/leaderboard.html">Ranking</a>
      <a class="link active" href="/exam.html">Examen</a>
      <div class="spacer"></div>
      <span class="chip"><i>üî•</i> Racha: <b id="chip-streak">1</b></span>
      <span class="chip"><i>‚≠ê</i> XP: <b id="chip-xp">0</b></span>
    </div>
  </header>

  <main>
    <!-- Presets -->
    <section class="card">
      <div class="hdr">
        <h2>Simuladores oficiales</h2>
      </div>
      <div class="body">
        <div class="presets">
          <button class="pill" id="preset-paa">PAA (UTP) ‚Äî 2 secciones, 60+60 min</button>
          <button class="pill" id="preset-pca">PCA (UP) ‚Äî 2 secciones, 120 min</button>
          <button class="pill" id="preset-pcg">PCG (UP) ‚Äî 4 secciones, 120 min</button>
        </div>
      </div>
    </section>

    <!-- Config y Generaci√≥n -->
    <section class="card" style="margin-top:20px">
      <div class="hdr">
        <h2>Examen personalizado</h2>
        <div class="meta">
          <span class="badge">Tiempo total: <b id="time-total">120:00</b></span>
          <span class="badge">Tiempo restante: <b id="time-left">‚Äî</b></span>
        </div>
      </div>
      <div class="body">
        <div class="row">
          <div class="control">
            <label>Dificultad</label>
            <select id="difficulty">
              <option value="easy">F√°cil</option>
              <option value="medium" selected>Media</option>
              <option value="hard">Dif√≠cil</option>
            </select>
          </div>

          <div class="control">
            <label>Preguntas por secci√≥n</label>
            <input id="count-per-section" type="number" min="1" max="60" value="30" />
          </div>

          <div class="control" style="align-self:end">
            <button id="btn-generate" class="btn">Generar examen</button>
          </div>
        </div>

        <div id="exam-msg" class="msg hint" style="margin-top:12px;">
          Selecciona dificultad y genera tu examen.
        </div>

        <div class="divider"></div>

        <div id="exam-output" class="section"></div>

        <div style="margin-top:12px">
          <div class="footer-hint">
            ¬øBanco insuficiente? Baja ‚ÄúPreguntas por secci√≥n‚Äù o agrega m√°s √≠tems en <code>public.questions</code>.
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    (function() {
      // ---------- Helpers ----------
      const $ = sel => document.querySelector(sel);
      const $$ = sel => document.querySelectorAll(sel);

      function getMode() {
        const m = new URLSearchParams(location.search).get('mode');
        return (m || 'paa').toLowerCase();
      }
      function setURLMode(mode) {
        const u = new URL(location.href);
        u.searchParams.set('mode', mode);
        location.href = u.toString();
      }
      function niceTime(sec) {
        sec = Math.max(0, sec|0);
        const m = Math.floor(sec/60), s = sec%60;
        return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
      }

      // ---------- UI Estado ----------
      const chipXP = $('#chip-xp'), chipStreak = $('#chip-streak');
      try {
        chipXP.textContent = localStorage.getItem('ingresou_xp') || '0';
        chipStreak.textContent = localStorage.getItem('ingresou_streak') || '1';
      } catch {}

      const btnPAA = $('#preset-paa'), btnPCA = $('#preset-pca'), btnPCG = $('#preset-pcg');
      const btnGenerate = $('#btn-generate');
      const elCount = $('#count-per-section');
      const elMsg = $('#exam-msg'), elOut = $('#exam-output');
      const elTotal = $('#time-total'), elLeft = $('#time-left');

      // activar preset visual
      function paintActivePreset() {
        const m = getMode();
        [btnPAA, btnPCA, btnPCG].forEach(b => b.classList.remove('active'));
        if (m==='paa') btnPAA.classList.add('active');
        if (m==='pca') btnPCA.classList.add('active');
        if (m==='pcg') btnPCG.classList.add('active');

        const totalByMode = { paa:120, pca:120, pcg:120 };
        elTotal.textContent = `${totalByMode[m] || 120}:00`;
        elLeft.textContent = '‚Äî';
      }

      btnPAA.addEventListener('click', () => setURLMode('paa'));
      btnPCA.addEventListener('click', () => setURLMode('pca'));
      btnPCG.addEventListener('click', () => setURLMode('pcg'));

      // ---------- Timer ----------
      let timerId = null, remaining = 0;
      function stopTimer(){ if (timerId) { clearInterval(timerId); timerId=null; } }
      function startTimer(totalSec){
        stopTimer();
        remaining = totalSec|0;
        elLeft.textContent = niceTime(remaining);
        timerId = setInterval(() => {
          remaining--;
          elLeft.textContent = niceTime(remaining);
          if (remaining <= 0) stopTimer();
        }, 1000);
      }

      // ---------- Render ----------
      function renderExam(json){
        const sections = json.sections || [];
        elOut.innerHTML = '';

        sections.forEach(sec => {
          const box = document.createElement('section');
          box.className = 'section';

          const h = document.createElement('h3');
          h.textContent = `${sec.title} ‚Äî ${sec.items.length} preguntas`;
          box.appendChild(h);

          sec.items.forEach(q => {
            const card = document.createElement('div');
            card.className = 'q';
            const p = document.createElement('div');
            p.className = 'p';
            p.textContent = `${q.n}. ${q.prompt}`;
            card.appendChild(p);

            const choices = document.createElement('div');
            choices.className = 'choices';
            (q.choices||[]).forEach((opt, idx) => {
              const id = `q${q.id}-${idx}`;
              const line = document.createElement('label');
              line.className = 'choice';
              line.innerHTML = `<input type="radio" name="q_${q.id}" id="${id}" value="${idx}" /> <span>${opt}</span>`;
              choices.appendChild(line);
            });
            card.appendChild(choices);
            elOut.appendChild(card);
          });

          elOut.appendChild(box);
        });

        startTimer(json.total_time_seconds || 120*60);
      }

      // ---------- Generar ----------
      async function generateExam(){
        try{
          elMsg.className = 'msg';
          elMsg.textContent = 'Generando‚Ä¶';

          const mode = getMode();
          const count = Math.max(1, parseInt(elCount.value||'10', 10));

          const resp = await fetch('/api/generate-exam', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ mode, count_per_section: count })
          });
          const json = await resp.json();

          if (!json.ok){
            if (json.error === 'BANK_SHORTAGE'){
              const falta = (json.missing||[])
                .map(x => `${x.topic}: ${x.have}/${x.need}`)
                .join(' ¬∑ ');
              elMsg.className = 'msg warn';
              elMsg.innerHTML = `Banco insuficiente para <b>${(json.mode||mode).toUpperCase()}</b>. Falta: ${falta}.<br>
              ‚Ä¢ Intenta bajar ‚ÄúPreguntas por secci√≥n‚Äù o agrega m√°s √≠tems en <code>public.questions</code>.`;
              elOut.innerHTML = '';
              stopTimer();
              elLeft.textContent = '‚Äî';
              return;
            }
            elMsg.className = 'msg err';
            elMsg.textContent = `Error: ${json.error || 'desconocido'}`;
            elOut.innerHTML='';
            stopTimer();
            elLeft.textContent='‚Äî';
            return;
          }

          elMsg.className = 'msg ok';
          const secsTxt = (json.sections||[]).map(s=>`${s.title} (${s.items.length})`).join(' ¬∑ ');
          elMsg.innerHTML = `Examen listo (${json.exam}/${json.subject}). Secciones: ${secsTxt}. ¬°√âxitos!`;

          renderExam(json);
        }catch(e){
          elMsg.className = 'msg err';
          elMsg.textContent = `Error: ${e.message}`;
          stopTimer();
          elLeft.textContent='‚Äî';
        }
      }

      btnGenerate.addEventListener('click', generateExam);

      // ---------- Boot ----------
      paintActivePreset();
      // Autogenerar si viene ?autostart=1
      if (new URLSearchParams(location.search).get('autostart') === '1'){
        generateExam();
      }
    })();
  </script>
</body>
</html>

